<!DOCTYPE html>
<html>
<head>
    <title>Share Products - Product Data Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: #faf9f7;
            color: #1d1d1f;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
        }

        .subtitle {
            font-size: 18px;
            color: #494949;
            margin-bottom: 40px;
        }

        .form-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            border: 1px solid #e8e8ed;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e8e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            color: #1d1d1f;
            background: #f5f5f7;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: ui-monospace, "SF Mono", Monaco, monospace;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #0071e3;
            background: white;
        }

        .button-group {
            display: flex;
            gap: 16px;
            margin-top: 32px;
        }

        .button {
            display: inline-block;
            padding: 14px 28px;
            background-color: #1d1d1f;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .button:hover {
            background-color: #000;
            transform: translateY(-2px);
        }

        .button.secondary {
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .button.secondary:hover {
            background-color: #e8e8ed;
        }

        .help-text {
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
        }

        #successMessage {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #34c759;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        #successMessage.show {
            opacity: 1;
            transform: translateY(0);
        }

        .error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 8px;
        }

        #output {
            font-family: ui-monospace, "SF Mono", Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
            min-height: 300px;
            padding: 16px;
            white-space: pre;
            overflow-x: auto;
        }

        #resultCard {
            margin-top: 24px;
        }

        #resultCard .button-group {
            margin-top: 16px;
        }

        .saved-products-section {
            margin-top: 48px;
        }

        .saved-products-section h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #1d1d1f;
        }

        .products-table-container {
            background: white;
            border-radius: 24px;
            border: 1px solid #e8e8ed;
            overflow: hidden;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .products-table th {
            text-align: left;
            padding: 16px;
            background-color: #f5f5f7;
            font-weight: 500;
            color: #1d1d1f;
            border-bottom: 1px solid #e8e8ed;
        }

        .products-table td {
            padding: 16px;
            vertical-align: top;
            border-bottom: 1px solid #e8e8ed;
        }

        .product-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .product-preview, .product-full {
            font-family: ui-monospace, "SF Mono", Monaco, monospace;
            font-size: 13px;
            color: #494949;
            line-height: 1.6;
        }

        .product-full pre {
            margin: 8px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .feed-spec-cell {
            width: 25%;
        }

        .feed-content {
            font-family: ui-monospace, "SF Mono", Monaco, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            color: #494949;
        }

        .date-cell {
            width: 15%;
            color: #86868b;
            font-size: 13px;
        }

        .delete-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .delete-button:hover {
            background-color: #ff3b3030;
        }

        .delete-icon {
            color: #ff3b30;
            font-size: 20px;
            line-height: 1;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #86868b;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .action-buttons {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .button.danger {
            background-color: #ff3b30;
        }

        .button.danger:hover {
            background-color: #d70015;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid #d2d2d7;
            cursor: pointer;
            transition: all 0.2s ease;
            accent-color: #0071e3;
        }

        .product-preview {
            position: relative;
            max-height: 120px;
            overflow: hidden;
            margin-top: 8px;
            margin-bottom: 32px;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .preview-content, .full-content {
            font-family: ui-monospace, "SF Mono", Monaco, monospace;
            font-size: 13px;
            line-height: 24px;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            color: #494949;
        }

        .fade-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, white);
            pointer-events: none;
        }

        .expand-button {
            position: absolute;
            bottom: -24px;
            left: 0;
            background: none;
            border: none;
            color: #0071e3;
            padding: 4px 0;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
            z-index: 2;
        }

        .expand-button:hover {
            text-decoration: underline;
        }

        .product-full {
            margin-top: 8px;
        }

        .product-full .expand-button {
            position: static;
            display: block;
            margin-top: 8px;
        }

        .hidden {
            display: none;
        }

        .action-buttons {
            margin-bottom: 20px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .button.danger {
            background-color: #dc3545;
            color: white;
        }

        .button.danger:hover {
            background-color: #c82333;
        }

        .button.danger:disabled {
            background-color: #dc354580;
            cursor: not-allowed;
        }

        .products-table th:first-child,
        .products-table td:first-child {
            text-align: center;
            vertical-align: middle;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-size: 14px;
            color: #1d1d1f;
            display: block;
        }

        .user-role {
            font-size: 12px;
            color: #86868b;
            display: block;
            margin-top: 2px;
            text-transform: capitalize;
        }

        .logout-button {
            background-color: #e8e8ed;
            color: #1d1d1f;
            border: none;
            padding: 8px 16px;
            border-radius: 980px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .logout-button:hover {
            background-color: #d8d8d8;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            z-index: 1001;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
        }

        .modal-message {
            font-size: 16px;
            color: #494949;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .modal-button.primary {
            background-color: #0071e3;
            color: white;
        }

        .modal-button.primary:hover {
            background-color: #0077ED;
        }

        .modal-button.secondary {
            background-color: #e8e8ed;
            color: #1d1d1f;
        }

        .modal-button.secondary:hover {
            background-color: #d8d8d8;
        }

        .modal-button.danger {
            background-color: #ff3b30;
            color: white;
        }

        .modal-button.danger:hover {
            background-color: #d70015;
        }

        .radio-group {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #0071e3;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
        }

        .api-spec-section {
            display: none;
        }

        .api-spec-section.active {
            display: block;
        }

        .products-table th:nth-child(1) { width: 50px; }
        .products-table th:nth-child(2) { width: auto; }
        .products-table th:nth-child(3) { width: 120px; }
        .products-table th:nth-child(4) { width: 200px; }
        .products-table th:nth-child(5) { width: 120px; }

        .category-cell {
            font-size: 14px;
            color: #494949;
            min-width: 120px;
        }

        .section-label {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 16px;
            display: block;
        }

        .conversion-options {
            display: grid;
            gap: 16px;
        }

        .conversion-option {
            background: white;
            border: 2px solid #e8e8ed;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .conversion-option:hover {
            border-color: #0071e3;
            background: #f5f5f7;
        }

        .conversion-option input[type="radio"] {
            position: absolute;
            top: 24px;
            right: 24px;
            margin: 0;
            width: 20px;
            height: 20px;
            accent-color: #0071e3;
        }

        .conversion-option.selected {
            border-color: #0071e3;
            background: #f5f5f7;
        }

        .option-content {
            margin-right: 40px;
        }

        .option-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .option-icon {
            font-size: 24px;
        }

        .option-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        .option-desc {
            font-size: 14px;
            color: #666;
            margin: 0;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="user-info">
        <div class="user-details">
            <span class="user-name">{{ current_user.first_name }} {{ current_user.last_name }}</span>
            <span class="user-role">{{ current_user.user_type }}</span>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-button">Log Out</a>
    </div>

    <div class="container">
        <div class="header">
            <h1>Share Product Data</h1>
            <p class="subtitle">Convert your product information into any format</p>
        </div>

        <form id="convertForm" class="form-card" onsubmit="handleSubmit(event)">
            <div class="form-group">
                <label for="product_url">Product Page URL</label>
                <input type="text" id="product_url" name="product_url" required
                       placeholder="https://example.com/product">
                <p class="help-text">Enter the URL of the product page you want to convert</p>
            </div>

            <div class="form-group mb-3">
                <label class="section-label">Conversion Type:</label>
                <div class="conversion-options">
                    <div class="conversion-option" onclick="selectConversionType('custom_api')">
                        <input class="form-check-input" type="radio" name="conversionType" id="customApi" value="custom_api" checked>
                        <div class="option-content">
                            <div class="option-header">
                                <div class="option-icon">üìã</div>
                                <h4>Custom Feed Specification</h4>
                            </div>
                            <p class="option-desc">Define your own data structure using a custom API specification</p>
                        </div>
                    </div>
                    
                    <div class="conversion-option" onclick="selectConversionType('structured_json')">
                        <input class="form-check-input" type="radio" name="conversionType" id="structuredJson" value="structured_json">
                        <div class="option-content">
                            <div class="option-header">
                                <div class="option-icon">ü§ñ</div>
                                <h4>Structured JSON (AI-generated)</h4>
                            </div>
                            <p class="option-desc">Let AI automatically extract and structure the product data</p>
                        </div>
                    </div>
                    
                    <div class="conversion-option" onclick="selectConversionType('template')">
                        <input class="form-check-input" type="radio" name="conversionType" id="template" value="template">
                        <div class="option-content">
                            <div class="option-header">
                                <div class="option-icon">üìù</div>
                                <h4>Use Template</h4>
                            </div>
                            <p class="option-desc">Choose from pre-defined templates for popular distribution channels</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group mb-3" id="templateSelect" style="display: none;">
                <label for="templateDropdown">Select Template:</label>
                <select class="form-select" id="templateDropdown">
                    <option value="">Loading templates...</option>
                </select>
            </div>

            <div class="form-group mb-3" id="apiSpecGroup">
                <label for="apiSpec">API Specification:</label>
                <textarea class="form-control" id="apiSpec" rows="5" placeholder="Enter your API specification here"></textarea>
            </div>

            <div class="button-group">
                <button type="submit" class="button">Convert Product</button>
            </div>
        </form>

        <div id="resultCard" class="form-card" style="display: none;">
            <div class="form-group">
                <label>Converted Product Data</label>
                <textarea id="output" readonly></textarea>
                <div class="button-group">
                    <button class="button" onclick="saveProduct()">Save Product</button>
                    <button class="button secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
                </div>
            </div>
        </div>

        <div class="saved-products-section">
            <h2>Saved Products</h2>
            
            <!-- Action buttons -->
            <div class="action-buttons">
                <button class="button danger" onclick="deleteSelected()" id="deleteSelectedBtn" disabled>
                    Delete Selected
                </button>
            </div>

            <div class="products-table-container">
                {% if products %}
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all" class="checkbox"></th>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Feed Format</th>
                                <th>Saved</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>
                                    <input type="checkbox" 
                                           class="checkbox product-checkbox" 
                                           data-product-id="{{ product.id }}"
                                           onchange="updateButtonStates()">
                                </td>
                                <td>
                                    <div class="product-title">{{ product.name }}</div>
                                    <div class="product-preview">
                                        <pre>{{ product.content|truncate(200, True, '...') }}</pre>
                                        <div class="fade-overlay"></div>
                                        <button class="expand-button" onclick="toggleContent(this)">Show more</button>
                                    </div>
                                    <div class="product-full hidden">
                                        <pre>{{ product.content }}</pre>
                                        <button class="expand-button" onclick="toggleContent(this)">Show less</button>
                                    </div>
                                </td>
                                <td class="category-cell">{{ product.category }}</td>
                                <td class="feed-spec-cell">
                                    <div class="feed-content">{{ product.api_spec }}</div>
                                </td>
                                <td class="date-cell">{{ product.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <p>No saved products yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="successMessage"></div>

    <!-- Add modal HTML structure -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        async function handleSubmit(event) {
            event.preventDefault();
            
            const productUrl = document.getElementById('product_url').value;
            if (!productUrl) {
                showAlert('Please enter a product URL');
                return;
            }
            
            const conversionType = document.querySelector('input[name="conversionType"]:checked').value;
            let apiSpec = '';
            let templateId = '';
            
            if (conversionType === 'template') {
                templateId = templateDropdown.value;
                if (!templateId) {
                    showAlert('Please select a template');
                    return;
                }
            } else if (conversionType === 'custom_api') {
                apiSpec = document.getElementById('apiSpec').value;
                if (!apiSpec) {
                    showAlert('Please enter an API specification');
                    return;
                }
            }
            
            // Show loading state
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Converting...';
            submitButton.disabled = true;
            
            fetch('/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    product_url: productUrl,
                    api_spec: apiSpec,
                    template_id: templateId,
                    conversion_type: conversionType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error);
                } else {
                    const formattedOutput = JSON.stringify(JSON.parse(data.content), null, 2);
                    document.getElementById('output').value = formattedOutput;
                    document.getElementById('output').dataset.apiSpec = data.feed_spec;
                    document.getElementById('resultCard').style.display = 'block';
                    document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while converting the product');
            })
            .finally(() => {
                // Reset button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        }

        async function saveProduct() {
            const output = document.getElementById('output');
            let content;
            try {
                content = JSON.parse(output.value);
            } catch (error) {
                showAlert('Invalid JSON format', 'Error');
                return;
            }
            const apiSpec = output.dataset.apiSpec;
            
            try {
                const response = await fetch('/save-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        api_spec: apiSpec
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save product');
                }

                showSuccessMessage(`Saved: ${data.name}`);
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Error saving product: ' + error.message, 'Error');
            }
        }

        function copyToClipboard() {
            const output = document.getElementById('output');
            output.select();
            document.execCommand('copy');
            showSuccessMessage('Copied to clipboard!');
        }

        function showSuccessMessage(message) {
            const messageEl = document.getElementById('successMessage');
            messageEl.textContent = message;
            messageEl.classList.add('show');
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 2000);
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const response = await fetch(`/delete-product/${productId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }

                // Refresh the page to show updated list
                location.reload();
            } catch (error) {
                alert('Error deleting product: ' + error.message);
            }
        }

        function toggleContent(id) {
            const preview = document.getElementById(`preview-${id}`);
            const full = document.getElementById(`full-${id}`);
            
            if (preview.classList.contains('hidden')) {
                preview.classList.remove('hidden');
                full.classList.add('hidden');
            } else {
                preview.classList.add('hidden');
                full.classList.remove('hidden');
            }
        }

        function updateButtonStates() {
            const selectedCount = document.querySelectorAll('.product-checkbox:checked').length;
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) {
                deleteSelectedBtn.disabled = selectedCount === 0;
            }
        }

        function toggleAllCheckboxes(mainCheckbox) {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = mainCheckbox.checked;
            });
            updateButtonStates();
        }

        async function downloadSelected() {
            const selectedIds = getSelectedProductIds();
            if (selectedIds.length === 0) {
                alert('Please select at least one product');
                return;
            }

            try {
                const response = await fetch('/download-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_ids: selectedIds
                    })
                });

                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'selected_products.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading products: ' + error.message);
            }
        }

        async function downloadAll() {
            try {
                const response = await fetch('/download-all');
                if (!response.ok) {
                    throw new Error('Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'all_products.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading products: ' + error.message);
            }
        }

        async function deleteSelected() {
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked'))
                .map(checkbox => checkbox.dataset.productId);
            
            if (selectedIds.length === 0) {
                showAlert('Please select at least one product to delete');
                return;
            }

            showConfirm(
                `Are you sure you want to delete ${selectedIds.length} selected product(s)?`,
                async () => {
                    try {
                        const response = await fetch('/delete-selected', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                product_ids: selectedIds
                            })
                        });

                        if (!response.ok) {
                            const data = await response.json();
                            throw new Error(data.error || 'Failed to delete products');
                        }

                        showSuccessMessage('Products deleted successfully');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } catch (error) {
                        console.error('Error deleting products:', error);
                        showAlert('Error deleting products: ' + error.message, 'Error');
                    }
                },
                'Delete Products'
            );
        }

        async function deleteAll() {
            if (!confirm('Are you sure you want to delete ALL products?')) {
                return;
            }

            try {
                const response = await fetch('/delete-all', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Deletion failed');
                }

                location.reload();
            } catch (error) {
                alert('Error deleting products: ' + error.message);
            }
        }

        function getSelectedProductIds() {
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.productId);
        }

        // Add modal handling functions
        function showModal({ title, message, buttons }) {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';

            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = `modal-button ${button.type || 'secondary'}`;
                btn.textContent = button.text;
                btn.onclick = () => {
                    hideModal();
                    button.onClick?.();
                };
                modalButtons.appendChild(btn);
            });

            modalOverlay.style.display = 'block';
        }

        function hideModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function showAlert(message, title = 'Alert') {
            showModal({
                title,
                message,
                buttons: [{
                    text: 'OK',
                    type: 'primary',
                }]
            });
        }

        function showConfirm(message, onConfirm, title = 'Confirm') {
            showModal({
                title,
                message,
                buttons: [
                    {
                        text: 'Cancel',
                        type: 'secondary',
                    },
                    {
                        text: 'OK',
                        type: 'primary',
                        onClick: onConfirm
                    }
                ]
            });
        }

        // Add new function to toggle conversion type
        function toggleConversionType() {
            const apiSpecSection = document.getElementById('apiSpecSection');
            const customApiRadio = document.getElementById('custom_api');
            
            if (customApiRadio.checked) {
                apiSpecSection.classList.add('active');
                document.getElementById('api_spec').required = true;
            } else {
                apiSpecSection.classList.remove('active');
                document.getElementById('api_spec').required = false;
            }
        }

        function selectConversionType(type) {
            // Update radio button
            document.querySelector(`input[value="${type}"]`).checked = true;
            
            // Update visual selection
            document.querySelectorAll('.conversion-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`input[value="${type}"]`).closest('.conversion-option').classList.add('selected');
            
            // Show/hide relevant sections
            const apiSpecGroup = document.getElementById('apiSpecGroup');
            const templateSelect = document.getElementById('templateSelect');
            
            if (type === 'template') {
                apiSpecGroup.style.display = 'none';
                templateSelect.style.display = 'block';
            } else if (type === 'custom_api') {
                apiSpecGroup.style.display = 'block';
                templateSelect.style.display = 'none';
            } else {
                apiSpecGroup.style.display = 'none';
                templateSelect.style.display = 'none';
            }
        }

        // Initialize the selected state
        document.addEventListener('DOMContentLoaded', function() {
            const selectedType = document.querySelector('input[name="conversionType"]:checked').value;
            selectConversionType(selectedType);
        });

        document.addEventListener('DOMContentLoaded', function() {
            const conversionTypeInputs = document.querySelectorAll('input[name="conversionType"]');
            const apiSpecGroup = document.getElementById('apiSpecGroup');
            const templateSelect = document.getElementById('templateSelect');
            const templateDropdown = document.getElementById('templateDropdown');
            
            // Load templates when page loads
            fetch('/api/templates')
                .then(response => response.json())
                .then(templates => {
                    templateDropdown.innerHTML = '<option value="">Select a template...</option>' +
                        templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                })
                .catch(error => console.error('Error loading templates:', error));
            
            // Handle conversion type change
            conversionTypeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'template') {
                        apiSpecGroup.style.display = 'none';
                        templateSelect.style.display = 'block';
                    } else if (this.value === 'custom_api') {
                        apiSpecGroup.style.display = 'block';
                        templateSelect.style.display = 'none';
                    } else {
                        // For structured_json
                        apiSpecGroup.style.display = 'none';
                        templateSelect.style.display = 'none';
                    }
                });
            });
            
            // Update the existing handleSubmit function
            window.handleSubmit = function(event) {
                event.preventDefault();
                
                const productUrl = document.getElementById('product_url').value;
                if (!productUrl) {
                    showAlert('Please enter a product URL');
                    return;
                }
                
                const conversionType = document.querySelector('input[name="conversionType"]:checked').value;
                let apiSpec = '';
                let templateId = '';
                
                if (conversionType === 'template') {
                    templateId = templateDropdown.value;
                    if (!templateId) {
                        showAlert('Please select a template');
                        return;
                    }
                } else if (conversionType === 'custom_api') {
                    apiSpec = document.getElementById('apiSpec').value;
                    if (!apiSpec) {
                        showAlert('Please enter an API specification');
                        return;
                    }
                }
                
                // Show loading state
                const submitButton = document.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Converting...';
                submitButton.disabled = true;
                
                fetch('/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_url: productUrl,
                        api_spec: apiSpec,
                        template_id: templateId,
                        conversion_type: conversionType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert(data.error);
                    } else {
                        const formattedOutput = JSON.stringify(JSON.parse(data.content), null, 2);
                        document.getElementById('output').value = formattedOutput;
                        document.getElementById('output').dataset.apiSpec = data.feed_spec;
                        document.getElementById('resultCard').style.display = 'block';
                        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred while converting the product');
                })
                .finally(() => {
                    // Reset button state
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
            };
        });
    </script>
</body>
</html> 